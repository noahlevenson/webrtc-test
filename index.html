<!DOCTYPE html>
<html>

<head>

</head>

<body>
Hello bitch, paste your shit below:

<br>

<textarea id="peer-offer" style="width: 500px; height: 300px;"></textarea>

<br>

<button type="button" id="make-offer-button">make offer</button>
<button type="button" id="accept-offer-button">accept offer</button>
<button type="button" id="accept-answer-button">accept answer</button>
<button type="button" id="new-ice-candidate-button">add ice candidate</button>
<button type="button" id="send-message-button" disabled="true">send msg</button>


<script>
function initDataChannel(ch) {
	ch.onopen = (e) => {
		console.log(`Data channel is open`);
	};

	ch.onmessage = (e) => {
		console.log(`Message received from peer: ${e.data}`);
	};
}

const offerTextArea = document.getElementById("peer-offer");
const makeOfferButton = document.getElementById("make-offer-button");
const acceptOfferButton = document.getElementById("accept-offer-button");
const acceptAnswerButton = document.getElementById("accept-answer-button");
const newIceCandidateButton = document.getElementById("new-ice-candidate-button");
const sendMessageButton = document.getElementById("send-message-button");

const rtcConfig = {
	iceServers: [
		{
			urls: "stun:stun.l.google.com:19302"
		}
	]
};

const localConnection = new RTCPeerConnection(rtcConfig);
let dataChannel = null;

// icecandidate fires when the connection sets its local description
// the event object contains the ICE candidate which must be signalled to the remote peer
localConnection.onicecandidate = (e) => {
	console.log(`Announcing my local ice candidate (null denotes end of candidates):`);
	console.log(JSON.stringify(e.candidate));
};

makeOfferButton.onclick = (e) => {
	dataChannel = localConnection.createDataChannel("myDataChannel");
	initDataChannel(dataChannel);

	localConnection.createOffer().then((offer) => {
		localConnection.setLocalDescription(offer);

		console.log(`My offer is:`);
		console.log(JSON.stringify(offer));
	});
};

acceptOfferButton.onclick = (e) => {
	localConnection.setRemoteDescription(JSON.parse(offerTextArea.value)).then(() => {
		return localConnection.createAnswer();
	}).then((answer) => {
		localConnection.setLocalDescription(answer);

		console.log(`My answer is:`);
		console.log(JSON.stringify(answer));

		offerTextArea.value = null;
	});
};

acceptAnswerButton.onclick = (e) => {
	localConnection.setRemoteDescription(JSON.parse(offerTextArea.value)).then(() => {
		offerTextArea.value = null;
	});
};

newIceCandidateButton.onclick = (e) => {
	const c = new RTCIceCandidate(JSON.parse(offerTextArea.value));

	localConnection.addIceCandidate(c).catch((err) => {
		console.log(`Error adding ICE candidate: ${err}`);
	});

	offerTextArea.value = null;
};

sendMessageButton.onclick = (e) => {
	dataChannel.send(offerTextArea.value);
	offerTextArea.value = null;
};

localConnection.ondatachannel = (e) => {
	dataChannel = e.channel
	initDataChannel(dataChannel);

	console.log("data channel achieved, bitch");
	sendMessageButton.disabled = false;
};
</script>

</body>
</html>
